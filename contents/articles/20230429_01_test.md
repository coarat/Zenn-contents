---
title: "Pythonã§Windows ã‚µãƒ¼ãƒ“ã‚¹(SocketServer)ã‚’ä½œæˆ"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Python,Windows,Service,Socket]
published: true

---

Windows 2019Server(Windows10ã§ã‚‚åŒã˜)
Python 3.7.8

# Pythonã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

python-3.7.8.exeã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ä»Šå›ã¯è«¸äº‹æƒ…ã§32bitç‰ˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ãŒ64bitç‰ˆã§ã‚‚å•é¡Œãªã„ã¯ãš

# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Windowsã‚µãƒ¼ãƒ“ã‚¹ã¨ã„ã†ã“ã¨ã§ä»Šå›ã¯pywin32ã‚’ä½¿ç”¨ã™ã‚‹

```
pip install pywin32
```

â€»ã‚‚ã—ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§64bitç‰ˆã®pywin32ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã—ã¾ã†å ´åˆã¯32bitç‰ˆã®.whlãƒ•ã‚¡ã‚¤ãƒ«ã‚’äº‹å‰ã«æº–å‚™ã—ç›´æ¥æŒ‡å®šã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã„ã¾ã—ã‚‡ã†

# ç’°å¢ƒå¤‰æ•°

ä»¥ä¸‹ã®6ã¤ã®ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹

```
# ãƒ¦ãƒ¼ã‚¶ç’°å¢ƒå¤‰æ•°.path
C:\Users\<ãƒ¦ãƒ¼ã‚¶å>\AppData\Local\Programs\Python\Python37-32\Scripts\
C:\Users\<ãƒ¦ãƒ¼ã‚¶å>\AppData\Local\Programs\Python\Python37-32\
```

```
# ã‚·ã‚¹ãƒ†ãƒ ç’°å¢ƒå¤‰æ•°.path
C:\Users\<ãƒ¦ãƒ¼ã‚¶å>\AppData\Local\Programs\Python\Python37-32\Scripts\
C:\Users\<ãƒ¦ãƒ¼ã‚¶å>\AppData\Local\Programs\Python\Python37-32\
C:\Users\<ãƒ¦ãƒ¼ã‚¶å>\AppData\Local\Programs\Python\Python37-32\Lib\site-packages\pywin32_system32
C:\Users\<ãƒ¦ãƒ¼ã‚¶å>\AppData\Local\Programs\Python\Python37-32\Lib\site-packages\win32
```

# å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«

ä»Šå›ã¯ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚‚ã‚ã‚‹é€šã‚ŠSocketServerã‚µãƒ¼ãƒ“ã‚¹ã‚’Pythonã§å®Ÿè£…ã™ã‚‹
å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã®2ã¤ã§ã™

- service.py
- server.py

```python:service.py
import os
import win32service
import win32serviceutil
import win32event
import logging
import servicemanager
import socket
import datetime

from socketserver import ThreadingTCPServer
import server

logging.basicConfig(
    filename=ãƒ­ã‚°å‡ºåŠ›å…ˆ,
    level=logging.DEBUG,
    format="%(asctime)s:LINE[%(lineno)s] %(levelname)s %(message)s"
)

class PythonService(win32serviceutil.ServiceFramework):
    _svc_name_ = 'SocketServer Test'
    _svc_display_name_ = 'SocketServer Test'
    _svc_description_ = 'SocketServer Test description'

    def __init__(self, args):
        win32serviceutil.ServiceFramework.__init__(self, args)
        self.stop_event = win32event.CreateEvent(None, 0, 0, None)
        socket.setdefaulttimeout(60)
        self.stop_requested = False

        ipaddr = 'IPã‚¢ãƒ‰ãƒ¬ã‚¹'
        port = ãƒãƒ¼ãƒˆç•ªå·
        address = (ipaddr, int(port))
        sockserver = ThreadingTCPServer(address, server.EchoHandler)
        self.sockserver = sockserver

    def SvcStop(self):
        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)
        win32event.SetEvent(self.stop_event)
        self.stop_requested = True
        self.sockserver.shutdown()

    def SvcDoRun(self):
        servicemanager.LogMsg(
            servicemanager.EVENTLOG_INFORMATION_TYPE,
            servicemanager.PYS_SERVICE_STARTED,
            (self._svc_name_, '')
        )
        self.main()

    def main(self):
        while True:
            if self.stop_requested:
                break
            try:
                ThreadingTCPServer.allow_reuse_address = True
                self.sockserver.serve_forever()
            except Exception as e:
                logging.error(str(type(e)))
                logging.error(str(e.args))
                logging.error(str(e))

if __name__ == '__main__':
    win32serviceutil.HandleCommandLine(PythonService)
```

```python:server.py
from socketserver import BaseRequestHandler
import logging
import datetime
import os

logging.basicConfig(
    filename=ãƒ­ã‚°å‡ºåŠ›å…ˆ,
    level=logging.DEBUG,
    format="%(asctime)s:LINE[%(lineno)s] %(levelname)s %(message)s"
)

class EchoHandler(BaseRequestHandler):
    def handle(self):
        try:
            message = self.request.recv(1024)
            logging.info(message)
            self.request.sendall(message)

        except Exception as e:
            logging.error(str(type(e)))
            logging.error(str(e.args))
            logging.error(str(e))

```

## æ³¨æ„ç‚¹

- ä¸Šè¨˜ã®2ãƒ•ã‚¡ã‚¤ãƒ«ã¯åŒã˜ãƒ•ã‚©ãƒ«ãƒ€å†…ã«é…ç½®ã—ã¾ã—ã‚‡ã†
- serve_forever()ã—ãŸsocketserverã¯ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢æ™‚ã«å¿…ãšshutdownã•ã›ã‚‹å‡¦ç†ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚ã“ã‚Œã‚’ã—ãªã„ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã§ããšã€å‰Šé™¤ã‚‚å‡ºæ¥ãªããªã‚Šã¾ã™

# ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²

é…ç½®ã—ãŸpythonãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™

```
# ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²
python service.py install
# ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹
python service.py start
```

[ã‚¹ã‚¿ãƒ¼ãƒˆ]â‡’[Windows ç®¡ç†ãƒ„ãƒ¼ãƒ«]â‡’[ã‚µãƒ¼ãƒ“ã‚¹]ã§ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†